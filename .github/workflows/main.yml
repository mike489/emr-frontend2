name: Notify Telegram on main push

on:
  push:
    branches:
      - main

permissions:
  contents: read

concurrency:
  group: notify-telegram-main
  cancel-in-progress: true

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram (main push)
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

          PROJECT_NAME: ${{ github.event.repository.name }}
          REPO_FULL: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}

          ACTOR: ${{ github.actor }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
        run: |
          TEXT=$'ðŸ“Œ New push\n\n'
          TEXT+=$'â€¢ Project: '"EMR - Frontend"$'\n'
          TEXT+=$'â€¢ Repo: '"${REPO_FULL}"$'\n'
          TEXT+=$'â€¢ Branch: '"${BRANCH}"$'\n'
          TEXT+=$'â€¢ By: '"${ACTOR}"$'\n'
          TEXT+=$'â€¢ Message: '"${COMMIT_MSG}"$'\n'
          TEXT+=$'â€¢ Commit: '"${COMMIT_URL}"$'\n'

          curl -sS -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
            -d "chat_id=${CHAT_ID}" \
            --data-urlencode "text=${TEXT}" \
            -d "disable_web_page_preview=true" > /dev/null
